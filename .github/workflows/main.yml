name: Build Stealth ResetpropT

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: 'thangnguyen2303/resetpropT'
          fetch-depth: 0

      - name: Install NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_ROOT=$(pwd)/android-ndk-r26b" >> $GITHUB_ENV

      - name: Fetch Missing Bionic Headers
        run: |
          # Tạo cấu trúc thư mục để bù đắp các file header hệ thống bị thiếu trong repo
          mkdir -p jni/api jni/system_properties
          
          # Tải các header thiết yếu từ Magisk/Bionic (đảm bảo biên dịch được)
          wget -q https://raw.githubusercontent.com/topjohnwu/Magisk/master/native/jni/system_properties/include/api/_system_properties.h -O jni/api/_system_properties.h
          wget -q https://raw.githubusercontent.com/topjohnwu/Magisk/master/native/jni/system_properties/include/system_properties/prop_info.h -O jni/system_properties/prop_info.h
          wget -q https://raw.githubusercontent.com/topjohnwu/Magisk/master/native/jni/system_properties/include/system_properties/prop_area.h -O jni/system_properties/prop_area.h

      - name: Stealth Patching (Safe Method)
        run: |
          cd jni
          # Thay vì dùng -D, chúng ta chèn Macro vào cuối file header resetprop.hpp 
          # Điều này đảm bảo các header hệ thống đã load xong mới bị vô hiệu hóa log
          echo -e "\n#define printf(...) (void)0\n#define fprintf(...) (void)0" >> resetprop.hpp
          
          # Đổi tên chuỗi tàng hình
          sed -i 's/"resetprop"/"sys_helper"/g' *.cpp || true

      - name: Compile Static Binary
        run: |
          cd jni
          export TOOLCHAIN=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64
          export CLANG=$TOOLCHAIN/bin/aarch64-linux-android33-clang++

          # Chỉ compile những file core quan trọng, bỏ qua persist.cpp nếu nó gây lỗi pb.h
          # Repo này dùng #include "system_property_api.cpp" nên ta không liệt kê nó trong danh sách compile
          $CLANG \
            -I . \
            resetprop.cpp \
            -std=c++17 \
            -Os \
            -static \
            -D_GNU_SOURCE \
            -D_REALLY_INCLUDE_SYS__SYSTEM_PROPERTIES_H_ \
            -fdata-sections -ffunction-sections \
            -Wl,--gc-sections \
            -fvisibility=hidden \
            -fno-rtti \
            -fno-exceptions \
            -s \
            -o ../miui_sys_helper

      - name: Verify & Upload
        run: |
          if [ -f miui_sys_helper ]; then
            file miui_sys_helper
            ls -al miui_sys_helper
          else
            echo "Build failed! Checking directory content:"
            ls -R
            exit 1
          fi

      - name: Archive Binary
        uses: actions/upload-artifact@v4
        with:
          name: miui_sys_helper_static
          path: miui_sys_helper
